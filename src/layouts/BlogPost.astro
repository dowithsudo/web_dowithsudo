---
// src/layouts/BlogPost.astro
import BaseLayout from './BaseLayout.astro';
import { getCollection } from 'astro:content';
import { Image } from 'astro:assets'; 
import type { MarkdownHeading } from 'astro';

interface Props {
    title: string;
    description?: string;
    date: Date; 
    updatedDate?: Date;
    cover?: any; 
    coverAlt?: string;
    headings: MarkdownHeading[];
    reference?: string;
}

const { title, description, date, updatedDate, cover, coverAlt, headings, reference } = Astro.props;

// 1. Logika Deteksi Bahasa & Label
const isEn = Astro.url.pathname.startsWith('/en');
const labels = {
  toc: isEn ? "Table of Contents" : "Daftar Isi",
  ctaTitle: isEn ? "Need IT Solutions?" : "Butuh Solusi IT?",
  ctaDesc: isEn 
    ? "DoWithSudo team is ready to help setup servers, VPS, and your security systems." 
    : "Tim DoWithSudo siap membantu setup server, VPS, dan sistem keamanan lo.",
  ctaBtn: isEn ? "Contact Us" : "Hubungi Kami",
  related: isEn ? "Related Posts" : "Artikel Terkait",
  pubAt: isEn ? "Published on" : "Dipublikasikan pada",
  noRelated: isEn ? "No other posts yet." : "Belum ada artikel lain."
};

// 2. Format Tanggal
const formatDate = (d: Date) => {
  return d.toLocaleDateString(isEn ? 'en-US' : 'id-ID', {
    year: 'numeric',
    month: 'long',
    day: 'numeric',
  });
};

// 3. Ambil Artikel Terkait (Limit 5)
const allPosts = await getCollection('blog');
const relatedPosts = allPosts
  .filter(p => {
    const postLang = p.id.startsWith('en/') ? 'en' : 'id';
    const currentLang = isEn ? 'en' : 'id';
    // Filter bahasa yang sama dan bukan artikel yang sedang dibuka
    return postLang === currentLang && p.data.title !== title;
  })
  .sort((a, b) => b.data.date.getTime() - a.data.date.getTime())
  .slice(0, 5); // <--- Update: Limit 5 artikel

const toc = headings ? headings.filter((h: MarkdownHeading) => h.depth >= 2 && h.depth <= 3) : [];
---

<BaseLayout title={title} description={description} reference={reference}>
  <div class="max-w-7xl mx-auto px-4 py-10 text-slate-900">
    <div class="grid grid-cols-1 lg:grid-cols-12 gap-12 items-start">
      
      <article class="lg:col-span-8 w-full">
        <header class="mb-8 text-left">
          <h1 class="text-4xl md:text-5xl font-bold mb-4 tracking-tight text-slate-900 leading-tight">
            {title}
          </h1>
          <div class="flex items-center gap-3 text-slate-500 text-sm italic">
            <span>{labels.pubAt}: {formatDate(date)}</span>
            {updatedDate && <span class="text-slate-300">|</span> <span>Update: {formatDate(updatedDate)}</span>}
          </div>
          
          {cover && (
            <div class="mt-8 overflow-hidden rounded-2xl shadow-xl border border-slate-100">
              <Image 
                src={cover} 
                alt={coverAlt || title} 
                width={1200}
                height={600}
                class="w-full h-auto object-cover max-h-[500px]"
                loading="eager"
              />
            </div>
          )}
        </header>

        <div class="prose prose-lg prose-slate max-w-none prose-headings:scroll-mt-24 prose-cyan text-left">
          <slot />
        </div>
      </article>

      <aside class="hidden lg:block lg:col-span-4 sticky top-28 self-start h-fit pb-10">
        <div class="flex flex-col gap-8 text-left">
          
          {toc.length > 0 && (
            <div class="bg-slate-50 p-6 rounded-2xl border border-slate-200 shadow-sm">
              <h3 class="font-bold text-lg mb-4 border-b border-slate-200 pb-2 text-slate-900">{labels.toc}</h3>
              <nav class="toc-container">
                <ul class="space-y-3 text-sm list-none">
                  {toc.map((h: MarkdownHeading) => (
                    <li class={`toc-item ${h.depth === 3 ? "ml-6 h3-item" : "h2-item font-medium"}`}>
                      <a 
                        href={`#${h.slug}`} 
                        class="text-slate-600 hover:text-cyan-600 transition-colors block leading-tight relative"
                      >
                        {h.text}
                      </a>
                    </li>
                  ))}
                </ul>
              </nav>
            </div>
          )}

          <div class="bg-linear-to-br from-cyan-600 to-blue-700 p-8 rounded-2xl text-white shadow-lg relative overflow-hidden group">
            <div class="relative z-10">
              <h3 class="font-bold text-xl mb-2 text-white">{labels.ctaTitle}</h3>
              <p class="text-cyan-50 text-sm mb-6 font-light">{labels.ctaDesc}</p>
              <a href={isEn ? "/en/contact" : "/id/contact"} class="bg-white text-cyan-600 px-6 py-3 rounded-xl font-bold text-sm inline-block hover:bg-slate-50 transition-all shadow-md">
                {labels.ctaBtn}
              </a>
            </div>
            <div class="absolute -right-8 -bottom-8 w-32 h-32 bg-white/10 rounded-full group-hover:scale-110 transition-transform duration-500"></div>
          </div>

          <div class="p-6 border border-slate-100 rounded-2xl bg-white shadow-sm">
            <h3 class="font-bold text-lg mb-4 text-slate-900">{labels.related}</h3>
            <ul class="space-y-5">
              {relatedPosts.length > 0 ? (
                relatedPosts.map((post) => (
                  <li class="group">
                    <a 
                      href={isEn ? `/en/blog/${post.id.split('/').pop()?.replace(/\.(md|mdx)$/, '')}` : `/id/blog/${post.id.split('/').pop()?.replace(/\.(md|mdx)$/, '')}`} 
                      class="flex flex-col gap-1"
                    >
                      <span class="text-[10px] text-cyan-600 font-black uppercase tracking-widest leading-none">
                        {post.data.category || 'Blog'}
                      </span>
                      <span class="text-sm font-semibold text-slate-700 group-hover:text-cyan-600 transition duration-300 leading-snug">
                        {post.data.title}
                      </span>
                      <span class="text-[11px] text-slate-400">
                        {formatDate(post.data.date)}
                      </span>
                    </a>
                  </li>
                ))
              ) : (
                <p class="text-sm text-slate-400 italic">{labels.noRelated}</p>
              )}
            </ul>
          </div>

        </div>
      </aside>

    </div>
  </div>
</BaseLayout>

<style is:global>
  html {
    scroll-behavior: smooth;
  }
  .prose h2::before, .prose h3::before { content: none !important; }
  .toc-container ul { counter-reset: h2-counter; }
  .h2-item { counter-increment: h2-counter; counter-reset: h3-counter; }
  .h2-item a::before {
    content: counter(h2-counter) ". ";
    font-weight: bold;
    color: #0891b2;
    margin-right: 0.5rem;
  }
  .h3-item { counter-increment: h3-counter; }
  .h3-item a::before {
    content: counter(h2-counter) "." counter(h3-counter) " ";
    font-size: 0.8em;
    color: #94a3b8;
    margin-right: 0.5rem;
  }
  .toc-container a {
    text-decoration: none !important;
    display: flex !important;
    align-items: flex-start;
  }
</style>