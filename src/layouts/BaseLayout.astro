---
// src/layouts/BaseLayout.astro
import { getCollection } from 'astro:content';

const { title = "DoWithSudo", reference } = Astro.props;

const url = Astro.url;
const pathname = url.pathname;
const siteUrl = Astro.site || 'https://dowithsudo.com';

// 1. Logika mendeteksi bahasa saat ini
const isEn = pathname.startsWith('/en');

// 2. Logika Menghasilkan URL bahasa alternatif (Pintar)
let alternatePath = isEn ? '/id/' : '/en/';

if (reference) {
  // Jika halaman ini adalah artikel blog (punya reference)
  const allPosts = await getCollection('blog');
  const partner = allPosts.find(p => 
    p.data.reference === reference && 
    (isEn ? p.id.startsWith('id/') : p.id.startsWith('en/'))
  );

  if (partner) {
    // Ambil slug dari file pasangannya
    const partnerSlug = partner.id.split('/').pop()?.split('.')[0];
    alternatePath = isEn ? `/id/blog/${partnerSlug}` : `/en/blog/${partnerSlug}`;
  } else {
    // Jika tidak ada pasangan, balikkan ke daftar blog bahasa tersebut
    alternatePath = isEn ? '/id/blog/' : '/en/blog/';
  }
} else {
  // Jika halaman umum (Home atau List Blog)
  if (pathname.includes('/blog')) {
    alternatePath = isEn ? '/id/blog/' : '/en/blog/';
  } else {
    alternatePath = isEn ? '/id/' : '/en/';
  }
}

// 3. Menyiapkan Absolute URL untuk SEO tags
// Untuk SEO, kita gunakan path pintar yang sudah ditemukan di atas
const currentUrl = new URL(pathname, siteUrl);
const idUrl = new URL(isEn ? alternatePath : pathname, siteUrl);
const enUrl = new URL(isEn ? pathname : alternatePath, siteUrl);
---

<html lang={isEn ? 'en' : 'id'}>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width" />
    <title>{title}</title>

    <link rel="canonical" href={currentUrl} />
    <link rel="alternate" hreflang="id" href={idUrl} />
    <link rel="alternate" hreflang="en" href={enUrl} />
    <link rel="alternate" hreflang="x-default" href={idUrl} />
  </head>
  <body>
    <nav>
      <div class="menu">
        <a href={isEn ? '/en/' : '/id/'}><strong>DoWithSudo</strong></a>
        <a href={isEn ? '/en/blog/' : '/id/blog/'}>Blog</a>
      </div>

      <div class="lang-switcher">
        {isEn ? (
          <a href={alternatePath} title="Ubah ke Bahasa Indonesia">
            <span class="flag">ðŸ‡®ðŸ‡©</span> ID
          </a>
        ) : (
          <a href={alternatePath} title="Change to English">
            <span class="flag">ðŸ‡ºðŸ‡¸</span> EN
          </a>
        )}
      </div>
    </nav>

    <hr />

    <main>
      <slot />
    </main>

    <style>
      nav { 
        display: flex; 
        justify-content: space-between; 
        align-items: center;
        padding: 1rem; 
        max-width: 800px;
        margin: 0 auto;
      }
      .menu { display: flex; gap: 1.5rem; }
      .menu a { text-decoration: none; color: inherit; font-weight: 500; }
      
      .lang-switcher a { 
        text-decoration: none; 
        font-weight: bold; 
        border: 1px solid #ddd; 
        padding: 4px 12px; 
        border-radius: 20px;
        font-size: 0.9rem;
        transition: all 0.2s;
        display: flex;
        align-items: center;
      }
      .lang-switcher a:hover {
        background: #f4f4f4;
        border-color: #bbb;
      }
      .flag { margin-right: 6px; line-height: 1; }
      
      main {
        max-width: 800px;
        margin: 0 auto;
        padding: 1rem;
      }
    </style>
  </body>
</html>